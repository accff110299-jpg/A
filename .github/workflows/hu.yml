name: Remote Android Emulator (Fast)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Thá»i gian cháº¡y (phÃºt)'
        required: true
        default: '30'
        type: string
      android_version:
        description: 'Android API Level'
        required: true
        default: '30'
        type: choice
        options:
          - '29'
          - '30'
          - '31'
          - '33'
      setup_mode:
        description: 'Cháº¿ Ä‘á»™'
        required: true
        default: 'quick'
        type: choice
        options:
          - 'quick'
          - 'fresh'

jobs:
  remote-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
    
    # Cache táº¥t cáº£ má»i thá»© Ä‘á»ƒ láº§n sau nhanh hÆ¡n
    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/android-sdk
        key: android-sdk-${{ inputs.android_version }}-v2
    
    - name: Cache AVD
      if: inputs.setup_mode == 'quick'
      uses: actions/cache@v4
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: avd-${{ inputs.android_version }}-tiktok-v3
    
    - name: Cache TikTok APK
      uses: actions/cache@v4
      id: apk-cache
      with:
        path: tiktok.apk
        key: tiktok-apk-v42.9.3
    
    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq xvfb x11vnc fluxbox wmctrl
    
    - name: Setup Android SDK
      if: steps.avd-cache.outputs.cache-hit != 'true' || inputs.setup_mode == 'fresh'
      uses: android-actions/setup-android@v3
    
    - name: Install System Image (if needed)
      if: steps.avd-cache.outputs.cache-hit != 'true' || inputs.setup_mode == 'fresh'
      run: |
        yes | sdkmanager --licenses || true
        sdkmanager "system-images;android-${{ inputs.android_version }};google_apis;x86_64"
        sdkmanager "platform-tools" "emulator"
    
    - name: Create AVD (if not cached)
      if: steps.avd-cache.outputs.cache-hit != 'true' || inputs.setup_mode == 'fresh'
      run: |
        echo "no" | avdmanager create avd -n test_avd -k "system-images;android-${{ inputs.android_version }};google_apis;x86_64" -d "pixel_5" -f
    
    - name: Download TikTok APK (if not cached)
      if: steps.apk-cache.outputs.cache-hit != 'true'
      run: |
        echo "ğŸ“¦ Táº£i TikTok APK v42.9.3..."
        wget --user-agent="Mozilla/5.0" --timeout=60 --tries=3 \
          -O tiktok.apk \
          "https://d-e03.winudf.com/b/APK/Y29tLnpoaWxpYW9hcHAubXVzaWNhbGx5XzIwMjQyMDkwMzBfODQ0NzcxZWE?_fn=VGlrVG9rIC0gVmlkZW9zLCBTaG9wICYgTElWRV80Mi45LjNfQVBLUHVyZS5hcGs&_p=Y29tLnpoaWxpYW9hcHAubXVzaWNhbGx5&download_id=otr_1124602165356072&is_hot=true&k=2b9c1038472fff6a9c32ba31e2fd9dff693903ea&uu=https%3A%2F%2Fd-02.winudf.com%2Fb%2FAPK%2FY29tLnpoaWxpYW9hcHAubXVzaWNhbGx5XzIwMjQyMDkwMzBfODQ0NzcxZWE%3Fk%3Dff5f89f9fd76c90ded027d32c405dc3e693903ea"
        echo "âœ… ÄÃ£ táº£i TikTok APK ($(du -h tiktok.apk | cut -f1))"
    
    - name: Setup VNC
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1280x720x24 > /dev/null 2>&1 &
        sleep 1
        fluxbox > /dev/null 2>&1 &
        sleep 1
        mkdir -p ~/.vnc
        x11vnc -storepasswd github ~/.vnc/passwd
        x11vnc -display :99 -rfbauth ~/.vnc/passwd -rfbport 5900 -shared -forever > /dev/null 2>&1 &
        sleep 1
    
    - name: Setup noVNC
      run: |
        git clone --depth 1 https://github.com/novnc/noVNC.git /tmp/novnc
        git clone --depth 1 https://github.com/novnc/websockify /tmp/novnc/utils/websockify
        cd /tmp/novnc
        ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 > /dev/null 2>&1 &
        sleep 2
    
    - name: Setup Cloudflare Tunnel
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        cloudflared tunnel --url http://localhost:6080 > /tmp/tunnel.log 2>&1 &
        
        # Äá»£i tunnel ready
        for i in {1..20}; do
          if grep -q "https://" /tmp/tunnel.log; then
            break
          fi
          sleep 1
        done
        
        TUNNEL_URL=$(cat /tmp/tunnel.log | grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' | head -1)
        echo "$TUNNEL_URL" > /tmp/tunnel_url.txt
        
        echo "=================================="
        echo "ğŸš€ READY IN ~30 SECONDS!"
        echo "=================================="
        echo "ğŸŒ URL: $TUNNEL_URL"
        echo "ğŸ”‘ Password: github"
        echo "=================================="
    
    - name: Start Emulator (FAST!)
      run: |
        export DISPLAY=:99
        export ANDROID_AVD_HOME=$HOME/.android/avd
        
        echo "âš¡ Khá»Ÿi Ä‘á»™ng emulator..."
        
        # Sá»­ dá»¥ng snapshot náº¿u cÃ³ (SIÃŠU NHANH)
        if [ "${{ steps.avd-cache.outputs.cache-hit }}" == "true" ] && [ "${{ inputs.setup_mode }}" == "quick" ]; then
          echo "ğŸ“¸ DÃ¹ng snapshot cÃ³ sáºµn - SIÃŠU NHANH!"
          $ANDROID_SDK_ROOT/emulator/emulator -avd test_avd -no-audio -gpu swiftshader_indirect -memory 4096 &
        else
          echo "ğŸ†• Boot láº§n Ä‘áº§u (sáº½ cháº­m hÆ¡n)"
          $ANDROID_SDK_ROOT/emulator/emulator -avd test_avd -no-snapshot-save -no-audio -gpu swiftshader_indirect -memory 4096 &
        fi
        
        $ANDROID_SDK_ROOT/platform-tools/adb wait-for-device
        
        while [ "$($ANDROID_SDK_ROOT/platform-tools/adb shell getprop sys.boot_completed | tr -d '\r')" != "1" ]; do
          sleep 2
        done
        
        echo "âœ… Emulator ready!"
    
    - name: Setup & Install TikTok
      run: |
        # Basic settings
        $ANDROID_SDK_ROOT/platform-tools/adb shell settings put secure lockscreen.disabled 1
        $ANDROID_SDK_ROOT/platform-tools/adb shell settings put system screen_off_timeout 1800000
        $ANDROID_SDK_ROOT/platform-tools/adb shell settings put global stay_on_while_plugged_in 3
        
        # Check náº¿u TikTok Ä‘Ã£ Ä‘Æ°á»£c cÃ i (tá»« snapshot)
        if $ANDROID_SDK_ROOT/platform-tools/adb shell pm list packages | grep -q "com.zhiliaoapp.musically"; then
          echo "âœ… TikTok Ä‘Ã£ cÃ³ sáºµn tá»« snapshot!"
        else
          echo "ğŸ“² CÃ i TikTok..."
          $ANDROID_SDK_ROOT/platform-tools/adb install -r tiktok.apk
          
          # Grant permissions
          $ANDROID_SDK_ROOT/platform-tools/adb shell pm grant com.zhiliaoapp.musically android.permission.CAMERA || true
          $ANDROID_SDK_ROOT/platform-tools/adb shell pm grant com.zhiliaoapp.musically android.permission.RECORD_AUDIO || true
          $ANDROID_SDK_ROOT/platform-tools/adb shell pm grant com.zhiliaoapp.musically android.permission.READ_EXTERNAL_STORAGE || true
          $ANDROID_SDK_ROOT/platform-tools/adb shell pm grant com.zhiliaoapp.musically android.permission.WRITE_EXTERNAL_STORAGE || true
          $ANDROID_SDK_ROOT/platform-tools/adb shell pm grant com.zhiliaoapp.musically android.permission.ACCESS_FINE_LOCATION || true
          
          echo "âœ… TikTok installed!"
        fi
    
    - name: Display Info
      run: |
        TUNNEL_URL=$(cat /tmp/tunnel_url.txt)
        
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   ğŸ‰ ANDROID EMULATOR READY!          â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "ğŸŒ URL: $TUNNEL_URL"
        echo "ğŸ”‘ Password: github"
        echo "â° Duration: ${{ inputs.duration }} phÃºt"
        echo "ğŸ“± Android API: ${{ inputs.android_version }}"
        echo "ğŸ“² TikTok: âœ… Installed"
        echo ""
        echo "ğŸ’¡ Tips:"
        echo "  â€¢ Láº§n Ä‘áº§u sáº½ cháº­m (~5 phÃºt)"
        echo "  â€¢ Láº§n sau SIÃŠU NHANH (~30 giÃ¢y)!"
        echo "  â€¢ Chá»n 'fresh' Ä‘á»ƒ reset emulator"
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    - name: Keep Alive
      run: |
        DURATION=$(($${{ inputs.duration }} * 60))
        END=$(($(date +%s) + DURATION))
        
        echo "â° Emulator sáº½ cháº¡y trong ${{ inputs.duration }} phÃºt"
        
        while [ $(date +%s) -lt $END ]; do
          REMAINING=$((END - $(date +%s)))
          MIN=$((REMAINING / 60))
          SEC=$((REMAINING % 60))
          
          printf "\râ±ï¸  CÃ²n: %02d:%02d" $MIN $SEC
          
          if ! $ANDROID_SDK_ROOT/platform-tools/adb devices | grep -q "emulator"; then
            echo -e "\nâŒ Emulator stopped!"
            break
          fi
          
          sleep 10
        done
        
        echo -e "\nâ° Time's up!"
    
    - name: Cleanup
      if: always()
      run: |
        pkill -f emulator || true
        pkill -f x11vnc || true
        pkill -f cloudflared || true
        pkill -f Xvfb || true
        echo "âœ… Cleaned up"
