name: Remote Android Emulator

on:
  workflow_dispatch:  # Ch·ªâ ch·∫°y manual ƒë·ªÉ tr√°nh l√£ng ph√≠ resources
    inputs:
      duration:
        description: 'Th·ªùi gian ch·∫°y (ph√∫t)'
        required: true
        default: '30'
        type: string
      android_version:
        description: 'Android API Level'
        required: true
        default: '30'
        type: choice
        options:
          - '29'
          - '30'
          - '31'
          - '33'

jobs:
  remote-android:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Max timeout ƒë·ªÉ tr√°nh ch·∫°y m√£i
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Enable KVM
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        ls -al /dev/kvm
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xvfb \
          x11vnc \
          fluxbox \
          wmctrl \
          libpulse0 \
          xdotool
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Accept Android licenses
      run: yes | sdkmanager --licenses || true
    
    - name: Install Android system image
      run: |
        sdkmanager "system-images;android-${{ inputs.android_version }};google_apis;x86_64"
        sdkmanager "platform-tools"
        sdkmanager "emulator"
    
    - name: Create AVD
      run: |
        echo "no" | avdmanager create avd \
          -n test_avd \
          -k "system-images;android-${{ inputs.android_version }};google_apis;x86_64" \
          -d "pixel_5" \
          -f
    
    - name: Setup VNC Server
      run: |
        # T·∫°o display ·∫£o
        export DISPLAY=:99
        Xvfb :99 -screen 0 1280x720x24 &
        sleep 2
        
        # Kh·ªüi ƒë·ªông window manager
        fluxbox &
        sleep 2
        
        # Setup VNC password
        mkdir -p ~/.vnc
        x11vnc -storepasswd github ~/.vnc/passwd
    
    - name: Install noVNC
      run: |
        git clone https://github.com/novnc/noVNC.git /tmp/novnc
        git clone https://github.com/novnc/websockify /tmp/novnc/utils/websockify
    
    - name: Start VNC Server
      run: |
        export DISPLAY=:99
        x11vnc -display :99 -rfbauth ~/.vnc/passwd -rfbport 5900 -shared -forever &
        sleep 2
    
    - name: Start noVNC
      run: |
        cd /tmp/novnc
        ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &
        sleep 3
    
    - name: Setup Cloudflare Tunnel (ƒë·ªÉ access t·ª´ ngo√†i)
      run: |
        # Download cloudflared
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
        sudo dpkg -i cloudflared-linux-amd64.deb
        
        # Start tunnel
        cloudflared tunnel --url http://localhost:6080 > /tmp/tunnel.log 2>&1 &
        sleep 10
        
        # L·∫•y URL
        cat /tmp/tunnel.log | grep -o 'https://[a-zA-Z0-9-]*\.trycloudflare\.com' | head -1 > /tmp/tunnel_url.txt
        TUNNEL_URL=$(cat /tmp/tunnel_url.txt)
        
        echo "=================================="
        echo "üåê VNC URL: $TUNNEL_URL"
        echo "üîë Password: github"
        echo "‚è∞ Th·ªùi gian: ${{ inputs.duration }} ph√∫t"
        echo "=================================="
        echo ""
        echo "üì± H∆∞·ªõng d·∫´n:"
        echo "1. M·ªü URL tr√™n trong browser"
        echo "2. Nh·∫≠p password: github"
        echo "3. Click Connect"
        echo "4. Ch·ªù emulator kh·ªüi ƒë·ªông"
        echo "=================================="
    
    - name: Start Android Emulator
      run: |
        export DISPLAY=:99
        export ANDROID_AVD_HOME=$HOME/.android/avd
        
        echo "ƒêang kh·ªüi ƒë·ªông Android Emulator..."
        $ANDROID_SDK_ROOT/emulator/emulator \
          -avd test_avd \
          -no-snapshot-save \
          -no-audio \
          -gpu swiftshader_indirect \
          -camera-back emulated \
          -camera-front emulated \
          -memory 4096 \
          -cores 2 &
        
        # Ch·ªù emulator boot xong
        echo "ƒê·ª£i emulator kh·ªüi ƒë·ªông..."
        $ANDROID_SDK_ROOT/platform-tools/adb wait-for-device
        
        # Ch·ªù boot animation xong
        while [ "$($ANDROID_SDK_ROOT/platform-tools/adb shell getprop sys.boot_completed | tr -d '\r')" != "1" ]; do
          echo "ƒêang boot..."
          sleep 5
        done
        
        echo "‚úÖ Emulator ƒë√£ s·∫µn s√†ng!"
        $ANDROID_SDK_ROOT/platform-tools/adb devices
    
    - name: Setup Emulator Settings
      run: |
        # T·∫Øt screen lock
        $ANDROID_SDK_ROOT/platform-tools/adb shell settings put secure lockscreen.disabled 1
        
        # TƒÉng screen timeout
        $ANDROID_SDK_ROOT/platform-tools/adb shell settings put system screen_off_timeout 1800000
        
        # Stay awake khi charging
        $ANDROID_SDK_ROOT/platform-tools/adb shell settings put global stay_on_while_plugged_in 3
        
        echo "‚úÖ C√†i ƒë·∫∑t emulator ho√†n t·∫•t"
    
    - name: Display Connection Info
      run: |
        echo "=================================="
        echo "üì± ANDROID EMULATOR IS READY!"
        echo "=================================="
        echo ""
        cat /tmp/tunnel_url.txt
        echo ""
        echo "Password: github"
        echo ""
        echo "Android Version: API ${{ inputs.android_version }}"
        echo "Duration: ${{ inputs.duration }} minutes"
        echo ""
        echo "=================================="
        echo "üí° Tips:"
        echo "- C√≥ th·ªÉ c√†i APK qua adb"
        echo "- C√≥ th·ªÉ d√πng Google Play Store"
        echo "- Control emulator qua mouse/keyboard"
        echo "=================================="
    
    - name: Keep Alive
      run: |
        DURATION_SECONDS=$(($${{ inputs.duration }} * 60))
        echo "‚è∞ Gi·ªØ emulator ch·∫°y trong ${{ inputs.duration }} ph√∫t..."
        
        END_TIME=$(($(date +%s) + DURATION_SECONDS))
        
        while [ $(date +%s) -lt $END_TIME ]; do
          REMAINING=$((END_TIME - $(date +%s)))
          MINUTES=$((REMAINING / 60))
          SECONDS=$((REMAINING % 60))
          
          echo "‚è±Ô∏è  C√≤n l·∫°i: ${MINUTES}m ${SECONDS}s"
          
          # Check emulator c√≤n s·ªëng kh√¥ng
          if ! $ANDROID_SDK_ROOT/platform-tools/adb devices | grep -q "emulator"; then
            echo "‚ùå Emulator ƒë√£ t·∫Øt!"
            break
          fi
          
          sleep 30
        done
        
        echo "‚è∞ H·∫øt th·ªùi gian!"
    
    - name: Cleanup
      if: always()
      run: |
        echo "üßπ D·ªçn d·∫πp..."
        pkill -f emulator || true
        pkill -f x11vnc || true
        pkill -f cloudflared || true
        pkill -f Xvfb || true
        echo "‚úÖ ƒê√£ d·ªçn d·∫πp xong"
