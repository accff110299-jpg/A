name: TikTok Event Automation

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in minutes (max 30)'
        required: true
        default: '30'

jobs:
  run-automation:
    runs-on: windows-latest
    timeout-minutes: 20

    steps:
      - name: Validate Duration
        run: |
          $duration = [int]"${{ github.event.inputs.duration }}"
          if ($duration -gt 30) {
            Write-Error "Duration cannot exceed 30 minutes"
            exit 1
          }
          echo "DURATION=$duration" >> $env:GITHUB_ENV

      - name: Configure RDP & Create User (Parallel)
        run: |
          # RDP Configuration
          $rdpJob = Start-Job -ScriptBlock {
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
            netsh advfirewall firewall delete rule name="RDP-Temp" 2>$null
            netsh advfirewall firewall add rule name="RDP-Temp" dir=in action=allow protocol=TCP localport=3389
            Restart-Service -Name TermService -Force
          }
          
          # Create user immediately
          $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%'
          $password = -join ((1..16) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "TempUser" -Password $securePass -AccountNeverExpires | Out-Null
          Add-LocalGroupMember -Group "Administrators" -Member "TempUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TempUser"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          # Wait for RDP config
          $rdpJob | Wait-Job | Receive-Job
          Write-Host "âœ“ RDP configured and user created"

      - name: Download All Installers (Parallel)
        run: |
          Write-Host "Downloading all installers in parallel..."
          
          $downloads = @(
              @{
                  Name = "MEmu"
                  Url = "https://dl.memuplay.com/MEmu_9.0.8.0_Offline_Installer.exe"
                  Path = "$env:TEMP\MEmu.exe"
              },
              @{
                  Name = "Tailscale"
                  Url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
                  Path = "$env:TEMP\tailscale.msi"
              }
          )
          
          $jobs = @()
          foreach ($dl in $downloads) {
              $jobs += Start-Job -ScriptBlock {
                  param($url, $path, $name)
                  $ProgressPreference = 'SilentlyContinue'
                  Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing
                  Write-Output "âœ“ $name downloaded"
              } -ArgumentList $dl.Url, $dl.Path, $dl.Name
          }
          
          # Wait for all downloads
          $jobs | Wait-Job | Receive-Job
          $jobs | Remove-Job
          Write-Host "âœ“ All downloads completed"

      - name: Install MEmu & Tailscale (Parallel)
        run: |
          Write-Host "Installing MEmu and Tailscale simultaneously..."
          
          # Start MEmu installation (async)
          $memuProcess = Start-Process -FilePath "$env:TEMP\MEmu.exe" -ArgumentList "/S" -PassThru -NoNewWindow
          
          # Install Tailscale while MEmu is installing
          Start-Process msiexec.exe -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/quiet", "/norestart" -Wait -NoNewWindow
          Write-Host "âœ“ Tailscale installed"
          
          # Wait for MEmu to finish
          $memuProcess | Wait-Process
          Write-Host "âœ“ MEmu installed"
          
          # Cleanup installers immediately
          Remove-Item "$env:TEMP\MEmu.exe", "$env:TEMP\tailscale.msi" -Force -ErrorAction SilentlyContinue

      - name: Configure MEmu & Connect Tailscale (Parallel)
        run: |
          # Configure MEmu in background
          $memuJob = Start-Job -ScriptBlock {
            Start-Sleep -Seconds 5
            $memuPath = "C:\Program Files\Microvirt\MEmu"
            if (Test-Path $memuPath) {
                $desktop = "C:\Users\runneradmin\Desktop"
                $WScriptShell = New-Object -ComObject WScript.Shell
                $Shortcut = $WScriptShell.CreateShortcut("$desktop\MEmu.lnk")
                $Shortcut.TargetPath = "$memuPath\MEmu.exe"
                $Shortcut.Save()
                Write-Output "âœ“ MEmu shortcut created"
            }
          }
          
          # Connect Tailscale immediately
          Write-Host "Connecting to Tailscale..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=tiktok-$env:GITHUB_RUN_ID --accept-routes
          
          # Get IP with retry
          $tsIP = $null
          for ($i = 0; $i -lt 10; $i++) {
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tsIP) { break }
              Start-Sleep -Seconds 2
          }
          
          if (-not $tsIP) {
              Write-Error "Failed to get Tailscale IP"
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ“ Tailscale connected: $tsIP"
          
          # Wait for MEmu config
          $memuJob | Wait-Job | Receive-Job | Write-Host
          $memuJob | Remove-Job

      - name: System Info & Connection Details
        run: |
          Write-Host "`n========================================="
          Write-Host "ðŸŽ® TikTok Event Automation - READY"
          Write-Host "========================================="
          Write-Host "ðŸ“¡ Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "ðŸ‘¤ Username: TempUser"
          Write-Host "ðŸ”‘ Password: $env:RDP_PASSWORD"
          Write-Host "â±ï¸  Duration: $env:DURATION minutes"
          Write-Host ""
          Write-Host "ðŸ“¦ Installed Software:"
          Write-Host "   âœ“ MEmu Emulator (Desktop)"
          Write-Host "   âœ“ Tailscale VPN"
          Write-Host ""
          Write-Host "ðŸ’» System Resources:"
          $cpu = Get-CimInstance -ClassName Win32_Processor | Select-Object -First 1
          $ram = Get-CimInstance -ClassName Win32_ComputerSystem
          Write-Host "   CPU: $($cpu.Name)"
          Write-Host "   RAM: $([math]::Round($ram.TotalPhysicalMemory/1GB, 2)) GB"
          Write-Host "   Cores: $($cpu.NumberOfCores) cores / $($cpu.NumberOfLogicalProcessors) threads"
          Write-Host "=========================================`n"

      - name: Keep Session Alive
        run: |
          $endTime = (Get-Date).AddMinutes($env:DURATION)
          $lastCheck = Get-Date
          
          Write-Host "ðŸš€ Session started at $(Get-Date -Format 'HH:mm:ss')"
          Write-Host "â° Session will end at $($endTime.ToString('HH:mm:ss'))`n"
          
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $remaining = ($endTime - $now).TotalMinutes
              
              # Show status every 30 seconds
              if (($now - $lastCheck).TotalSeconds -ge 30) {
                  $mins = [math]::Floor($remaining)
                  $secs = [math]::Round(($remaining - $mins) * 60)
                  Write-Host "[$($now.ToString('HH:mm:ss'))] âš¡ Active - $mins min $secs sec remaining"
                  $lastCheck = $now
                  
                  # Health check
                  $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json
                  if (-not $tsStatus) {
                      Write-Warning "âš ï¸  Tailscale connection lost, reconnecting..."
                      & "$env:ProgramFiles\Tailscale\tailscale.exe" up
                  }
              }
              
              Start-Sleep -Seconds 5
          }
          
          Write-Host "`nâ±ï¸  Session time expired. Cleaning up..."

      - name: Cleanup
        if: always()
        run: |
          Write-Host "ðŸ§¹ Cleaning up..."
          
          # Disconnect Tailscale
          & "$env:ProgramFiles\Tailscale\tailscale.exe" down 2>$null
          
          # Remove temporary user
          Remove-LocalUser -Name "TempUser" -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Cleanup completed"
