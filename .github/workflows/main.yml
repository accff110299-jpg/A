name: TikTok Event Automation

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in minutes (max 30)'
        required: true
        default: '30'

jobs:
  run-automation:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Validate Duration
        run: |
          $duration = [int]"${{ github.event.inputs.duration }}"
          if ($duration -gt 30) {
            Write-Error "Duration cannot exceed 15 minutes"
            exit 1
          }
          echo "DURATION=$duration" >> $env:GITHUB_ENV

      - name: Configure RDP & Create User (Parallel)
        run: |
          # RDP Configuration in background
          $rdpJob = Start-Job -ScriptBlock {
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
            netsh advfirewall firewall delete rule name="RDP-Temp" 2>$null
            netsh advfirewall firewall add rule name="RDP-Temp" dir=in action=allow protocol=TCP localport=3389
            Restart-Service -Name TermService -Force
          }
          
          # Create user immediately
          $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%'
          $password = -join ((1..16) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "TempUser" -Password $securePass -AccountNeverExpires | Out-Null
          Add-LocalGroupMember -Group "Administrators" -Member "TempUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TempUser"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          # Wait for RDP config
          $rdpJob | Wait-Job | Receive-Job | Out-Null
          $rdpJob | Remove-Job
          Write-Host "âœ“ RDP configured and user created"

      - name: Download MEmu Installer & Tailscale (Parallel)
        run: |
          Write-Host "Downloading MEmu installer and Tailscale..."
          
          $desktop = "C:\Users\runneradmin\Desktop"
          
          $downloads = @(
              @{
                  Name = "MEmu Installer"
                  Url = "https://dl.memuplay.com/download/MEmu-setup-abroad-a0d07d76.exe"
                  Path = "$desktop\MEmu-Installer.exe"
              },
              @{
                  Name = "Tailscale"
                  Url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
                  Path = "$env:TEMP\tailscale.msi"
              }
          )
          
          $jobs = @()
          foreach ($dl in $downloads) {
              $jobs += Start-Job -ScriptBlock {
                  param($url, $path, $name)
                  try {
                      $ProgressPreference = 'SilentlyContinue'
                      $headers = @{
                          'User-Agent' = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                      }
                      
                      Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing -Headers $headers -TimeoutSec 600
                      
                      if (Test-Path $path) {
                          $size = [math]::Round((Get-Item $path).Length / 1MB, 2)
                          Write-Output "âœ“ $name downloaded ($size MB)"
                      } else {
                          throw "File not found after download"
                      }
                  } catch {
                      Write-Error "âœ— $name failed: $($_.Exception.Message)"
                      throw
                  }
              } -ArgumentList $dl.Url, $dl.Path, $dl.Name
          }
          
          # Wait and check results
          $results = $jobs | Wait-Job | Receive-Job
          $jobs | Remove-Job
          
          $results | ForEach-Object { Write-Host $_ }
          
          # Verify both files exist
          if (-not (Test-Path "$desktop\MEmu-Installer.exe")) {
              Write-Error "MEmu installer download failed"
              exit 1
          }
          if (-not (Test-Path "$env:TEMP\tailscale.msi")) {
              Write-Error "Tailscale download failed"
              exit 1
          }
          
          Write-Host "âœ“ All downloads completed successfully"

      - name: Create MEmu Installation Guide
        run: |
          $desktop = "C:\Users\runneradmin\Desktop"
          
          # Create detailed instructions
          $instructions = @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   MEmu Installation Guide                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ® QUICK INSTALL (Takes 2-3 minutes):

1. Double-click 'MEmu-Installer.exe' on this Desktop
2. Click 'Install' or 'Next' through the wizard
3. Wait for installation to complete
4. MEmu will launch automatically when done

ğŸ’¡ TIPS:
- The installer is already downloaded (saves time!)
- Installation is fast on this VM
- You'll have ~13 minutes to use MEmu after installing

ğŸš€ After installation:
- MEmu will appear on Desktop
- Open MEmu and enjoy!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Session Info:
- Started at: $(Get-Date -Format 'HH:mm:ss')
- Duration: $env:DURATION minutes
- Will end at: $((Get-Date).AddMinutes($env:DURATION).ToString('HH:mm:ss'))

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"@
          
          $instructions | Out-File "$desktop\ğŸ“– INSTALL-MEMU-HERE.txt" -Encoding UTF8
          
          Write-Host "âœ“ Installation guide created on Desktop"

      - name: Install Tailscale
        run: |
          Write-Host "Installing Tailscale..."
          Start-Process msiexec.exe -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/quiet", "/norestart" -Wait -NoNewWindow
          Write-Host "âœ“ Tailscale installed"
          
          # Cleanup installer
          Remove-Item "$env:TEMP\tailscale.msi" -Force -ErrorAction SilentlyContinue

      - name: Connect Tailscale
        run: |
          Write-Host "Connecting to Tailscale network..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=tiktok-$env:GITHUB_RUN_ID --accept-routes --shields-up=false
          
          # Get IP with retry logic
          $tsIP = $null
          $maxRetries = 10
          for ($i = 1; $i -le $maxRetries; $i++) {
              Write-Host "Attempting to get Tailscale IP (try $i/$maxRetries)..."
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tsIP) { 
                  break 
              }
              Start-Sleep -Seconds 2
          }
          
          if (-not $tsIP) {
              Write-Error "Failed to get Tailscale IP after $maxRetries attempts"
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ“ Tailscale connected: $tsIP"

      - name: Prepare Desktop Environment
        run: |
          $desktop = "C:\Users\runneradmin\Desktop"
          
          # Create a welcome message on desktop
          $welcome = @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          Welcome to TikTok Event Automation Session           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… SESSION READY!

ğŸ“ TO DO:
1. Install MEmu by double-clicking 'MEmu-Installer.exe'
2. Wait 2-3 minutes for installation
3. Start using MEmu for your automation tasks

ğŸ“Š SESSION INFO:
- Tailscale IP: $env:TAILSCALE_IP
- Username: TempUser
- Time remaining: $env:DURATION minutes
- Session ends at: $((Get-Date).AddMinutes($env:DURATION).ToString('HH:mm:ss'))

ğŸ’¡ TIPS:
- Install MEmu first (it's quick!)
- All files are ready on Desktop
- Read 'ğŸ“– INSTALL-MEMU-HERE.txt' for detailed instructions

ğŸ® HAVE FUN!
"@
          
          $welcome | Out-File "$desktop\ğŸ¯ START-HERE.txt" -Encoding UTF8
          
          Write-Host "âœ“ Desktop environment prepared"

      - name: System Info & Connection Details
        run: |
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          Write-Host "â•‘        ğŸ® TikTok Event Automation - SESSION READY ğŸ®         â•‘"
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          Write-Host ""
          Write-Host "ğŸ“¡ CONNECTION INFO:"
          Write-Host "   â€¢ Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "   â€¢ Username: TempUser"
          Write-Host "   â€¢ Password: $env:RDP_PASSWORD"
          Write-Host "   â€¢ Duration: $env:DURATION minutes"
          Write-Host ""
          Write-Host "ğŸ“¦ WHAT'S READY:"
          Write-Host "   âœ“ Tailscale VPN (Connected)"
          Write-Host "   âœ“ RDP Access (Enabled)"
          Write-Host "   âœ“ MEmu Installer (On Desktop - Ready to install)"
          Write-Host "   âœ“ Installation Guide (On Desktop)"
          Write-Host ""
          Write-Host "ğŸ’» SYSTEM RESOURCES:"
          try {
              $cpu = Get-CimInstance -ClassName Win32_Processor | Select-Object -First 1
              $ram = Get-CimInstance -ClassName Win32_ComputerSystem
              $disk = Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DeviceID='C:'"
              
              Write-Host "   â€¢ CPU: $($cpu.Name)"
              Write-Host "   â€¢ RAM: $([math]::Round($ram.TotalPhysicalMemory/1GB, 2)) GB"
              Write-Host "   â€¢ Cores: $($cpu.NumberOfCores) cores / $($cpu.NumberOfLogicalProcessors) threads"
              Write-Host "   â€¢ Disk Free: $([math]::Round($disk.FreeSpace/1GB, 2)) GB"
          } catch {
              Write-Host "   (System info unavailable)"
          }
          Write-Host ""
          Write-Host "ğŸ”— HOW TO CONNECT:"
          Write-Host "   1. Make sure Tailscale is running on your PC"
          Write-Host "   2. Open Remote Desktop Connection (mstsc)"
          Write-Host "   3. Computer: $env:TAILSCALE_IP"
          Write-Host "   4. Login with credentials above"
          Write-Host "   5. Install MEmu from Desktop (2-3 minutes)"
          Write-Host "   6. Enjoy your session!"
          Write-Host ""
          Write-Host "â° Session started at: $(Get-Date -Format 'HH:mm:ss')"
          Write-Host "â° Session will end at: $((Get-Date).AddMinutes($env:DURATION).ToString('HH:mm:ss'))"
          Write-Host ""
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`n"

      - name: Keep Session Alive
        run: |
          $endTime = (Get-Date).AddMinutes($env:DURATION)
          $lastCheck = Get-Date
          $lastHealthCheck = Get-Date
          
          Write-Host "ğŸš€ Session is now ACTIVE!"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`n"
          
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $remaining = ($endTime - $now).TotalMinutes
              
              # Show status every 30 seconds
              if (($now - $lastCheck).TotalSeconds -ge 30) {
                  $mins = [math]::Floor($remaining)
                  $secs = [math]::Round(($remaining - $mins) * 60)
                  Write-Host "[$($now.ToString('HH:mm:ss'))] âš¡ Session Active - $mins min $secs sec remaining"
                  $lastCheck = $now
              }
              
              # Health check every 2 minutes
              if (($now - $lastHealthCheck).TotalMinutes -ge 2) {
                  try {
                      $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json
                      if (-not $tsStatus) {
                          Write-Warning "âš ï¸  Tailscale connection lost, attempting reconnect..."
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
                          Start-Sleep -Seconds 5
                      }
                  } catch {
                      Write-Warning "âš ï¸  Health check error (may be normal): $($_.Exception.Message)"
                  }
                  $lastHealthCheck = $now
              }
              
              Start-Sleep -Seconds 5
          }
          
          Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "â±ï¸  Session time expired. Starting cleanup..."

      - name: Cleanup
        if: always()
        run: |
          Write-Host "`nğŸ§¹ Cleaning up resources..."
          
          # Disconnect Tailscale
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down 2>$null
              Write-Host "âœ“ Tailscale disconnected"
          } catch {
              Write-Host "âš  Tailscale disconnect warning (may already be down)"
          }
          
          # Remove temporary user
          try {
              Remove-LocalUser -Name "TempUser" -ErrorAction SilentlyContinue
              Write-Host "âœ“ Temporary user removed"
          } catch {
              Write-Host "âš  User removal warning (may not exist)"
          }
          
          # Don't delete MEmu installer - user might want to use it
          Write-Host "â„¹ MEmu installer kept on Desktop for reference"
          
          Write-Host "âœ… Cleanup completed"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "ğŸ‘‹ Thank you for using TikTok Event Automation!"
