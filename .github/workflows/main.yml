name: TikTok Event Automation

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Duration in minutes (max 30)'
        required: true
        default: '30'

jobs:
  run-automation:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Validate Duration
        run: |
          $duration = [int]"${{ github.event.inputs.duration }}"
          if ($duration -gt 30) {
            Write-Error "Duration cannot exceed 15 minutes"
            exit 1
          }
          echo "DURATION=$duration" >> $env:GITHUB_ENV

      - name: Configure RDP & Create User (Parallel)
        run: |
          # RDP Configuration in background
          $rdpJob = Start-Job -ScriptBlock {
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
            Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
            netsh advfirewall firewall delete rule name="RDP-Temp" 2>$null
            netsh advfirewall firewall add rule name="RDP-Temp" dir=in action=allow protocol=TCP localport=3389
            Restart-Service -Name TermService -Force
          }
          
          # Create user immediately
          $chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%'
          $password = -join ((1..16) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "TempUser" -Password $securePass -AccountNeverExpires | Out-Null
          Add-LocalGroupMember -Group "Administrators" -Member "TempUser"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "TempUser"
          echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV
          
          # Wait for RDP config
          $rdpJob | Wait-Job | Receive-Job | Out-Null
          $rdpJob | Remove-Job
          Write-Host "âœ“ RDP configured and user created"

      - name: Download All Installers (Parallel)
        run: |
          Write-Host "Downloading installers in parallel..."
          
          $downloads = @(
              @{
                  Name = "MEmu"
                  Url = "https://dl.memuplay.com/download/MEmu-setup-abroad-a0d07d76.exe"
                  Path = "$env:TEMP\MEmu.exe"
              },
              @{
                  Name = "Tailscale"
                  Url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
                  Path = "$env:TEMP\tailscale.msi"
              }
          )
          
          $jobs = @()
          foreach ($dl in $downloads) {
              $jobs += Start-Job -ScriptBlock {
                  param($url, $path, $name)
                  try {
                      $ProgressPreference = 'SilentlyContinue'
                      $headers = @{
                          'User-Agent' = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                      }
                      
                      Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing -Headers $headers -TimeoutSec 600
                      
                      if (Test-Path $path) {
                          $size = [math]::Round((Get-Item $path).Length / 1MB, 2)
                          Write-Output "âœ“ $name downloaded ($size MB)"
                      } else {
                          throw "File not found after download"
                      }
                  } catch {
                      Write-Error "âœ— $name failed: $($_.Exception.Message)"
                      throw
                  }
              } -ArgumentList $dl.Url, $dl.Path, $dl.Name
          }
          
          # Wait and check results
          $results = $jobs | Wait-Job | Receive-Job
          $jobs | Remove-Job
          
          $results | ForEach-Object { Write-Host $_ }
          
          # Verify both files exist
          if (-not (Test-Path "$env:TEMP\MEmu.exe")) {
              Write-Error "MEmu download failed"
              exit 1
          }
          if (-not (Test-Path "$env:TEMP\tailscale.msi")) {
              Write-Error "Tailscale download failed"
              exit 1
          }
          
          Write-Host "âœ“ All downloads completed successfully"

      - name: Install MEmu & Tailscale (Parallel)
        run: |
          Write-Host "Installing MEmu and Tailscale simultaneously..."
          
          # Start MEmu installation (async)
          Write-Host "Starting MEmu installation..."
          $memuProcess = Start-Process -FilePath "$env:TEMP\MEmu.exe" -ArgumentList "/S" -PassThru -NoNewWindow
          
          # Install Tailscale while MEmu is installing
          Write-Host "Installing Tailscale..."
          Start-Process msiexec.exe -ArgumentList "/i", "$env:TEMP\tailscale.msi", "/quiet", "/norestart" -Wait -NoNewWindow
          Write-Host "âœ“ Tailscale installed"
          
          # Wait for MEmu to finish
          Write-Host "Waiting for MEmu installation to complete..."
          $memuProcess | Wait-Process
          Write-Host "âœ“ MEmu installed"
          
          # Cleanup installers immediately to save disk space
          Remove-Item "$env:TEMP\MEmu.exe", "$env:TEMP\tailscale.msi" -Force -ErrorAction SilentlyContinue
          Write-Host "âœ“ Installers cleaned up"

      - name: Configure MEmu & Connect Tailscale (Parallel)
        run: |
          # Configure MEmu in background
          $memuJob = Start-Job -ScriptBlock {
            Start-Sleep -Seconds 5
            $memuPath = "C:\Program Files\Microvirt\MEmu"
            if (Test-Path $memuPath) {
                $desktop = "C:\Users\runneradmin\Desktop"
                $WScriptShell = New-Object -ComObject WScript.Shell
                $Shortcut = $WScriptShell.CreateShortcut("$desktop\MEmu.lnk")
                $Shortcut.TargetPath = "$memuPath\MEmu.exe"
                $Shortcut.WorkingDirectory = $memuPath
                $Shortcut.Save()
                Write-Output "âœ“ MEmu shortcut created on Desktop"
            } else {
                Write-Output "âš  MEmu path not found: $memuPath"
            }
          }
          
          # Connect Tailscale immediately
          Write-Host "Connecting to Tailscale network..."
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=tiktok-$env:GITHUB_RUN_ID --accept-routes --shields-up=false
          
          # Get IP with retry logic
          $tsIP = $null
          $maxRetries = 10
          for ($i = 1; $i -le $maxRetries; $i++) {
              Write-Host "Attempting to get Tailscale IP (try $i/$maxRetries)..."
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
              if ($tsIP) { 
                  break 
              }
              Start-Sleep -Seconds 2
          }
          
          if (-not $tsIP) {
              Write-Error "Failed to get Tailscale IP after $maxRetries attempts"
              exit 1
          }
          
          echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          Write-Host "âœ“ Tailscale connected: $tsIP"
          
          # Wait for MEmu config
          $memuResult = $memuJob | Wait-Job | Receive-Job
          $memuJob | Remove-Job
          Write-Host $memuResult

      - name: System Info & Connection Details
        run: |
          Write-Host "`n========================================="
          Write-Host "ğŸ® TikTok Event Automation - READY"
          Write-Host "========================================="
          Write-Host "ğŸ“¡ Tailscale IP: $env:TAILSCALE_IP"
          Write-Host "ğŸ‘¤ Username: TempUser"
          Write-Host "ğŸ”‘ Password: $env:RDP_PASSWORD"
          Write-Host "â±ï¸  Duration: $env:DURATION minutes"
          Write-Host ""
          Write-Host "ğŸ“¦ Installed Software:"
          Write-Host "   âœ“ MEmu Emulator (Desktop shortcut)"
          Write-Host "   âœ“ Tailscale VPN"
          Write-Host ""
          Write-Host "ğŸ’» System Resources:"
          try {
              $cpu = Get-CimInstance -ClassName Win32_Processor | Select-Object -First 1
              $ram = Get-CimInstance -ClassName Win32_ComputerSystem
              $disk = Get-CimInstance -ClassName Win32_LogicalDisk -Filter "DeviceID='C:'"
              
              Write-Host "   CPU: $($cpu.Name)"
              Write-Host "   RAM: $([math]::Round($ram.TotalPhysicalMemory/1GB, 2)) GB"
              Write-Host "   Cores: $($cpu.NumberOfCores) cores / $($cpu.NumberOfLogicalProcessors) threads"
              Write-Host "   Disk Free: $([math]::Round($disk.FreeSpace/1GB, 2)) GB"
          } catch {
              Write-Host "   (System info unavailable)"
          }
          Write-Host ""
          Write-Host "ğŸ”— How to Connect:"
          Write-Host "   1. Make sure Tailscale is running on your PC"
          Write-Host "   2. Open Remote Desktop Connection (mstsc)"
          Write-Host "   3. Computer: $env:TAILSCALE_IP"
          Write-Host "   4. Login with credentials above"
          Write-Host "=========================================`n"

      - name: Keep Session Alive
        run: |
          $endTime = (Get-Date).AddMinutes($env:DURATION)
          $lastCheck = Get-Date
          $lastHealthCheck = Get-Date
          
          Write-Host "ğŸš€ Session started at $(Get-Date -Format 'HH:mm:ss')"
          Write-Host "â° Session will end at $($endTime.ToString('HH:mm:ss'))"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`n"
          
          while ((Get-Date) -lt $endTime) {
              $now = Get-Date
              $remaining = ($endTime - $now).TotalMinutes
              
              # Show status every 30 seconds
              if (($now - $lastCheck).TotalSeconds -ge 30) {
                  $mins = [math]::Floor($remaining)
                  $secs = [math]::Round(($remaining - $mins) * 60)
                  Write-Host "[$($now.ToString('HH:mm:ss'))] âš¡ Active - $mins min $secs sec remaining"
                  $lastCheck = $now
              }
              
              # Health check every 2 minutes
              if (($now - $lastHealthCheck).TotalMinutes -ge 2) {
                  try {
                      $tsStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json 2>$null | ConvertFrom-Json
                      if (-not $tsStatus) {
                          Write-Warning "âš ï¸  Tailscale connection lost, attempting reconnect..."
                          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
                          Start-Sleep -Seconds 5
                      }
                  } catch {
                      Write-Warning "âš ï¸  Health check failed: $($_.Exception.Message)"
                  }
                  $lastHealthCheck = $now
              }
              
              Start-Sleep -Seconds 5
          }
          
          Write-Host "`nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          Write-Host "â±ï¸  Session time expired. Initiating cleanup..."

      - name: Cleanup
        if: always()
        run: |
          Write-Host "`nğŸ§¹ Cleaning up resources..."
          
          # Disconnect Tailscale
          try {
              & "$env:ProgramFiles\Tailscale\tailscale.exe" down 2>$null
              Write-Host "âœ“ Tailscale disconnected"
          } catch {
              Write-Host "âš  Tailscale disconnect failed (may already be down)"
          }
          
          # Remove temporary user
          try {
              Remove-LocalUser -Name "TempUser" -ErrorAction SilentlyContinue
              Write-Host "âœ“ Temporary user removed"
          } catch {
              Write-Host "âš  User removal failed (may not exist)"
          }
          
          # Clean up any remaining temp files
          Remove-Item "$env:TEMP\MEmu*.exe", "$env:TEMP\tailscale*.msi" -Force -ErrorAction SilentlyContinue
          
          Write-Host "âœ… Cleanup completed successfully"
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
